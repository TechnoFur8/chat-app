# Настройка получения сообщений в чат-приложении

## Что было добавлено

### 1. Серверная часть (WebSocket)

**Файл: `server/src/lib/socket.js`**

Добавлен обработчик события `sendMessage`:

```javascript
socket.on("sendMessage", ({ receiverId, text, img, createdAt }) => {
    console.log("Получено сообщение:", { receiverId, text, img, createdAt })
    
    const receiverSocketId = userSocketMap[receiverId]
    
    if (receiverSocketId) {
        // Отправляем сообщение получателю
        socket.to(receiverSocketId).emit("message", {
            senderId: userId,
            receiverId: receiverId,
            userIdChat: receiverId,
            text: text,
            img: img,
            createdAt: createdAt
        })
        console.log(`Сообщение отправлено от ${userId} к ${receiverId}`)
    } else {
        console.log(`Получатель ${receiverId} не найден онлайн`)
    }
})
```

### 2. Клиентская часть

**Файл: `client/components/shared/chat-input.tsx`**

Добавлена отправка через WebSocket в дополнение к HTTP:

```javascript
const { sendMessage: sendSocketMessage, isConnected } = useSocketStore()

// В handleSend:
if (isConnected) {
    sendSocketMessage(messageData)
}
```

**Файл: `client/components/shared/chat-container.tsx`**

Добавлены:
- Уведомления о новых сообщениях
- Звуковые оповещения
- Индикатор статуса подключения
- Улучшенная обработка входящих сообщений

**Файл: `client/components/shared/socket-auto-connect.tsx`**

Улучшено автоматическое подключение с использованием JWT токена.

## Как это работает

### Процесс отправки сообщения:

1. **Пользователь вводит текст** в `ChatInput`
2. **Отправка через HTTP** - сообщение сохраняется в базе данных
3. **Отправка через WebSocket** - сообщение мгновенно доставляется получателю
4. **Получение на сервере** - сервер обрабатывает событие `sendMessage`
5. **Доставка получателю** - если получатель онлайн, сообщение отправляется через WebSocket
6. **Обновление UI** - получатель видит новое сообщение и слышит уведомление

### Особенности реализации:

- **Двойная отправка**: HTTP для надежности, WebSocket для скорости
- **Real-time уведомления**: Toast уведомления и звуковые сигналы
- **Индикатор статуса**: Показывает, подключен ли пользователь к WebSocket
- **Автоматическое переподключение**: При потере соединения
- **Логирование**: Подробные логи для отладки

## Запуск и тестирование

1. **Запустите сервер:**
   ```bash
   cd server
   npm start
   ```

2. **Запустите клиент:**
   ```bash
   cd client
   npm run dev
   ```

3. **Откройте приложение в двух вкладках браузера**

4. **Войдите под разными пользователями**

5. **Отправьте сообщение** - вы должны увидеть:
   - Мгновенное появление сообщения у получателя
   - Toast уведомление
   - Звуковой сигнал
   - Зеленый индикатор статуса подключения

## Отладка

### Проверьте консоль браузера:
- Логи подключения к WebSocket
- Логи получения сообщений
- Ошибки подключения

### Проверьте консоль сервера:
- Логи подключения пользователей
- Логи отправки сообщений
- Ошибки обработки

### Возможные проблемы:

1. **Сообщения не приходят**: Проверьте статус WebSocket подключения
2. **Нет звука**: Убедитесь, что файл `/Cat.mp3` существует в папке `public`
3. **Ошибки CORS**: Проверьте настройки CORS на сервере
4. **Проблемы с токеном**: Убедитесь, что JWT токен корректно передается

## Дополнительные улучшения

Для дальнейшего развития можно добавить:

- **Статус "печатает..."**
- **Статус доставки сообщений**
- **Уведомления в браузере** (Push API)
- **Шифрование сообщений**
- **Групповые чаты**
- **Отправка файлов** 